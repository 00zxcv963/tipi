<!DOCTYPE html>
<html>
<head>
	<title>TIPI: 深入理解PHP内核</title>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<link href="chm.css" media="screen" rel="stylesheet" type="text/css" />
<link href="highlight.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body id="portable" class="pdf">
			<div class='page '>
			<h2>第三节 预定义变量<a name='第三节 预定义变量'></a></h2>

<p>大家都知道PHP脚本在执行的时候用户全局变量(在用户空间显式定义的变量)会保存在一个HashTable数据类型的符号表(symbol_table)中，
在PHP中有一些比较特殊的全局变量例如:
$&#95;GET，$&#95;POST，$&#95;SERVER等变量，我们并没有在程序中定义这些变量，并且这些变量也同样保存在符号表中，
从这些表象我们不难得出结论：PHP是在脚本运行之前就将这些特殊的变量加入到了符号表中了。</p>

<h3>预定义变量$GLOBALS的初始化<a name='预定义变量$GLOBALS的初始化'></a></h3>

<p>我们以cgi模式为例说明$GLOBALS的初始化。
从cgi_main.c文件main函数开始。
整个调用顺序如下所示：</p>

<p><strong>[main() -> php_request_startup() -> zend_activate() -> init_executor() ]</strong></p>

<pre class="c">... <span class="co1">//  省略</span>
zend_hash_init<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">50</span><span class="sy0">,</span> <span class="kw2">NULL</span><span class="sy0">,</span> ZVAL_PTR_DTOR<span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#123;</span>
    zval <span class="sy0">*</span>globals<span class="sy0">;</span>
&nbsp;
    ALLOC_ZVAL<span class="br0">&#40;</span>globals<span class="br0">&#41;</span><span class="sy0">;</span>
    Z_SET_REFCOUNT_P<span class="br0">&#40;</span>globals<span class="sy0">,</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
    Z_SET_ISREF_P<span class="br0">&#40;</span>globals<span class="br0">&#41;</span><span class="sy0">;</span>
    Z_TYPE_P<span class="br0">&#40;</span>globals<span class="br0">&#41;</span> <span class="sy0">=</span> IS_ARRAY<span class="sy0">;</span>
    Z_ARRVAL_P<span class="br0">&#40;</span>globals<span class="br0">&#41;</span> <span class="sy0">=</span> <span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">;</span>
    zend_hash_update<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;GLOBALS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;GLOBALS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span>
        <span class="sy0">&amp;</span>globals<span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span>zval <span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw2">NULL</span><span class="br0">&#41;</span><span class="sy0">;</span>      <span class="co1">//  添加全局变量GLOBALS</span>
<span class="br0">&#125;</span>
... <span class="co1">//  省略</span></pre>

<p>上面的代码的关键点zend_hash_update函数的调用，它将变量名为GLOBALS的变量注册到EG(symbol_table)中，
EG(symbol_table)是一个HashTable的结构，用来存放所有的全局变量。
这在下面将要提到的$_GET等变量初始化时也会用到。</p>

<h3>$_GET、$_POST等变量的初始化<a name='$_GET、$_POST等变量的初始化'></a></h3>

<p><strong>$_GET、$_COOKIE、$_SERVER、$_ENV、$_FILES、$_REQUEST</strong>这六个变量都是通过如下的调用序列进行初始化。
<strong>[main() -> php_request_startup() -> php_hash_environment()  ]</strong><br />
在请求初始化时，通过调用 <strong>php_hash_environment</strong> 函数初始化以上的六个预定义的变量。
如下所示为php_hash_environment函数的代码。在代码之后我们以$_POST为例说明整个初始化的过程。</p>

<pre class="c"><span class="coMULTI">/* {{{ php_hash_environment
 */</span>
<span class="kw4">int</span> php_hash_environment<span class="br0">&#40;</span>TSRMLS_D<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
        <span class="kw4">char</span> <span class="sy0">*</span>p<span class="sy0">;</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> _gpc_flags<span class="br0">&#91;</span><span class="nu0">5</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span><span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#125;</span><span class="sy0">;</span>
        zend_bool jit_initialization <span class="sy0">=</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>auto_globals_jit<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>PG<span class="br0">&#40;</span>register_long_arrays<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw4">struct</span> auto_global_record <span class="br0">&#123;</span>
                <span class="kw4">char</span> <span class="sy0">*</span>name<span class="sy0">;</span>
                uint name_len<span class="sy0">;</span>
                <span class="kw4">char</span> <span class="sy0">*</span>long_name<span class="sy0">;</span>
                uint long_name_len<span class="sy0">;</span>
                zend_bool jit_initialization<span class="sy0">;</span>
        <span class="br0">&#125;</span> auto_global_records<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_POST&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_POST&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_POST_VARS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_POST_VARS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">0</span> <span class="br0">&#125;</span><span class="sy0">,</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_GET&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_GET&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_GET_VARS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_GET_VARS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">0</span> <span class="br0">&#125;</span><span class="sy0">,</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_COOKIE&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_COOKIE&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_COOKIE_VARS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_COOKIE_VARS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">0</span> <span class="br0">&#125;</span><span class="sy0">,</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_SERVER&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_SERVER&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_SERVER_VARS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_SERVER_VARS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">1</span> <span class="br0">&#125;</span><span class="sy0">,</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_ENV&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_ENV&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_ENV_VARS&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_ENV_VARS&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">1</span> <span class="br0">&#125;</span><span class="sy0">,</span>
                <span class="br0">&#123;</span> <span class="st0">&quot;_FILES&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_FILES&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="st0">&quot;HTTP_POST_FILES&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP_POST_FILES&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="nu0">0</span> <span class="br0">&#125;</span><span class="sy0">,</span>
        <span class="br0">&#125;</span><span class="sy0">;</span>
        size_t num_track_vars <span class="sy0">=</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span>auto_global_records<span class="br0">&#41;</span><span class="sy0">/</span><span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="kw4">struct</span> auto_global_record<span class="br0">&#41;</span><span class="sy0">;</span>
        size_t i<span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/* jit_initialization = 0; */</span>
        <span class="kw1">for</span> <span class="br0">&#40;</span>i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>num_track_vars<span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">NULL</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">&#40;</span>p<span class="sy0">=</span>PG<span class="br0">&#40;</span>variables_order<span class="br0">&#41;</span><span class="sy0">;</span> p <span class="sy0">&amp;&amp;</span> <span class="sy0">*</span>p<span class="sy0">;</span> p<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">switch</span><span class="br0">&#40;</span><span class="sy0">*</span>p<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="kw1">case</span> <span class="st0">'p'</span><span class="sy0">:</span>
                        <span class="kw1">case</span> <span class="st0">'P'</span><span class="sy0">:</span>
                                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>_gpc_flags<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>SG<span class="br0">&#40;</span>headers_sent<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> SG<span class="br0">&#40;</span>request_info<span class="br0">&#41;</span>.<span class="me1">request_method</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>strcasecmp<span class="br0">&#40;</span>SG<span class="br0">&#40;</span>request_info<span class="br0">&#41;</span>.<span class="me1">request_method</span><span class="sy0">,</span> <span class="st0">&quot;POST&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                        sapi_module.<span class="me1">treat_data</span><span class="br0">&#40;</span>PARSE_POST<span class="sy0">,</span> <span class="kw2">NULL</span><span class="sy0">,</span> <span class="kw2">NULL</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>   <span class="coMULTI">/* POST Data */</span>
                                        _gpc_flags<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                                        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                                php_autoglobal_merge<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> Z_ARRVAL_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_POST<span class="br0">&#93;</span><span class="br0">&#41;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        <span class="br0">&#125;</span>
                                <span class="br0">&#125;</span>
                                <span class="kw2">break</span><span class="sy0">;</span>
                        <span class="kw1">case</span> <span class="st0">'c'</span><span class="sy0">:</span>
                        <span class="kw1">case</span> <span class="st0">'C'</span><span class="sy0">:</span>
                                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>_gpc_flags<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                        sapi_module.<span class="me1">treat_data</span><span class="br0">&#40;</span>PARSE_COOKIE<span class="sy0">,</span> <span class="kw2">NULL</span><span class="sy0">,</span> <span class="kw2">NULL</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span> <span class="coMULTI">/* Cookie Data */</span>
                                        _gpc_flags<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                                        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                                php_autoglobal_merge<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> Z_ARRVAL_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_COOKIE<span class="br0">&#93;</span><span class="br0">&#41;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        <span class="br0">&#125;</span>
                                <span class="br0">&#125;</span>
                                <span class="kw2">break</span><span class="sy0">;</span>
                        <span class="kw1">case</span> <span class="st0">'g'</span><span class="sy0">:</span>
                        <span class="kw1">case</span> <span class="st0">'G'</span><span class="sy0">:</span>
                                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>_gpc_flags<span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                        sapi_module.<span class="me1">treat_data</span><span class="br0">&#40;</span>PARSE_GET<span class="sy0">,</span> <span class="kw2">NULL</span><span class="sy0">,</span> <span class="kw2">NULL</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>    <span class="coMULTI">/* GET Data */</span>
                                        _gpc_flags<span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                                        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                                php_autoglobal_merge<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> Z_ARRVAL_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_GET<span class="br0">&#93;</span><span class="br0">&#41;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        <span class="br0">&#125;</span>
                                <span class="br0">&#125;</span>
                                <span class="kw2">break</span><span class="sy0">;</span>
                        <span class="kw1">case</span> <span class="st0">'e'</span><span class="sy0">:</span>
                        <span class="kw1">case</span> <span class="st0">'E'</span><span class="sy0">:</span>
                                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>jit_initialization <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>_gpc_flags<span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                        zend_auto_global_disable_jit<span class="br0">&#40;</span><span class="st0">&quot;_ENV&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_ENV&quot;</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        php_auto_globals_create_env<span class="br0">&#40;</span><span class="st0">&quot;_ENV&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_ENV&quot;</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        _gpc_flags<span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                                        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                                php_autoglobal_merge<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> Z_ARRVAL_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_ENV<span class="br0">&#93;</span><span class="br0">&#41;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        <span class="br0">&#125;</span>
                                <span class="br0">&#125;</span>
                                <span class="kw2">break</span><span class="sy0">;</span>
                        <span class="kw1">case</span> <span class="st0">'s'</span><span class="sy0">:</span>
                        <span class="kw1">case</span> <span class="st0">'S'</span><span class="sy0">:</span>
                                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>jit_initialization <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>_gpc_flags<span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                        zend_auto_global_disable_jit<span class="br0">&#40;</span><span class="st0">&quot;_SERVER&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_SERVER&quot;</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        php_register_server_variables<span class="br0">&#40;</span>TSRMLS_C<span class="br0">&#41;</span><span class="sy0">;</span>
                                        _gpc_flags<span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                                        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_globals<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                                                php_autoglobal_merge<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> Z_ARRVAL_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_SERVER<span class="br0">&#93;</span><span class="br0">&#41;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                                        <span class="br0">&#125;</span>
                                <span class="br0">&#125;</span>
                                <span class="kw2">break</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="coMULTI">/* argv/argc support */</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_argc_argv<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                php_build_argv<span class="br0">&#40;</span>SG<span class="br0">&#40;</span>request_info<span class="br0">&#41;</span>.<span class="me1">query_string</span><span class="sy0">,</span> PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>TRACK_VARS_SERVER<span class="br0">&#93;</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">&#40;</span>i<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">;</span> i<span class="sy0">&lt;</span>num_track_vars<span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>jit_initialization <span class="sy0">&amp;&amp;</span> auto_global_records<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">jit_initialization</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        ALLOC_ZVAL<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        array_init<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        INIT_PZVAL<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
&nbsp;
                Z_ADDREF_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                zend_hash_update<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> auto_global_records<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">name</span><span class="sy0">,</span> auto_global_records<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">name_len</span><span class="sy0">,</span> <span class="sy0">&amp;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span>zval <span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw2">NULL</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>PG<span class="br0">&#40;</span>register_long_arrays<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        zend_hash_update<span class="br0">&#40;</span><span class="sy0">&amp;</span>EG<span class="br0">&#40;</span>symbol_table<span class="br0">&#41;</span><span class="sy0">,</span> auto_global_records<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">long_name</span><span class="sy0">,</span> auto_global_records<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">long_name_len</span><span class="sy0">,</span> <span class="sy0">&amp;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span>zval <span class="sy0">*</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw2">NULL</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        Z_ADDREF_P<span class="br0">&#40;</span>PG<span class="br0">&#40;</span>http_globals<span class="br0">&#41;</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="coMULTI">/* Create _REQUEST */</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>jit_initialization<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                zend_auto_global_disable_jit<span class="br0">&#40;</span><span class="st0">&quot;_REQUEST&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_REQUEST&quot;</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
                php_auto_globals_create_request<span class="br0">&#40;</span><span class="st0">&quot;_REQUEST&quot;</span><span class="sy0">,</span> <span class="kw4">sizeof</span><span class="br0">&#40;</span><span class="st0">&quot;_REQUEST&quot;</span><span class="br0">&#41;</span><span class="sy0">-</span><span class="nu0">1</span> TSRMLS_CC<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw1">return</span> SUCCESS<span class="sy0">;</span>
<span class="br0">&#125;</span></pre>

<p>以$_POST为例，首先以 <strong>auto_global_record</strong> 数组形式定义好将要初始化的变量的相关信息。
在变量初始化完成后，按照PG(variables_order)指定的顺序（在php.ini中指定），通过调用sapi_module.treat_data处理数据。</p>

<blockquote>
<p>从PHP实现的架构设计看，treat_data函数在SAPI目录下不同的服务器应该有不同的实现，只是现在大部分都是使用的默认实现。</p>
</blockquote>

<p>在treat_data后，如果打开了PG(register_globals)，则会调用php_autoglobal_merge将相关变量的值写到符号表。</p>

<p>以上的所有数据处理是一个赋值前的初始化行为。在此之后，通过遍历之前定义的结构体，
调用zend_hash_update，将相关变量的值赋值给&amp;EG(symbol_table)。
另外对于$_REQUEST有独立的处理方法。</p>
		</div>
	</body>
</html>
